# AGENTS.md - Usage Tracking Plugin

<instructions>
OpenCode plugin for tracking AI provider usage, rate limits, and quotas.
</instructions>

## Dev Flow
- `tsc --noEmit` - MUST use for type-checking before any commit.
- `npm run build` - Compiles project to `dist/`.
- `? RECOMMENDATION`: Implement a one-shot test command (e.g., `bun test` or `vitest`) as no test runner is currently configured in `package.json`.

<rules>
## Adding Providers
Implement `UsageProvider` interface from `src/providers/base.ts`:

```typescript
interface UsageProvider<TAuth = unknown> {
  id: string
  displayName: string
  usageEndpoint?: string
  parseRateLimitHeaders?: (headers: Record<string, string>) => UsageSnapshot | null
  fetchUsage?: (auth: TAuth) => Promise<UsageSnapshot | null>
}
```

1. Create `src/providers/<name>/` directory.
2. Register in `src/providers/index.ts` in the `providers` object.
3. Export the provider from `src/providers/index.ts`.

## Config Loading
`src/usage/config.ts` loads from `~/.config/opencode/usage-config.jsonc`:

```typescript
interface UsageConfig {
  endpoint?: string
  apiKey?: string
  timeout?: number
  providers?: { openai?: boolean; proxy?: boolean; copilot?: boolean }
}
```

## Hook System
`index.ts` wires three hook types from `src/hooks/`:
- `command.execute.before` - Intercepts commands via `src/hooks/command.ts`.
- `session.start` / `session.end` - Tracks per-session usage via `src/hooks/session.ts`.
- `proxy.response` - Intercepts HTTP responses for rate-limit headers via `src/hooks/proxy.ts`.

## Safety & Constraints
- MUST NOT run long-running/blocking processes (e.g., dev servers).
- MUST NOT modify `dist/` directly; it is generated by `tsc`.
- MUST NOT modify `package-lock.json` unless adding/removing dependencies.
</rules>

<context_hints>
**Critical files**
- `src/types.ts` - Shared schemas (UsageSnapshot, UsageEntry, PlanType).
- `src/providers/base.ts` - Interface contract for all usage providers.
- `src/state.ts` - In-memory usage snapshot cache.
- `src/index.ts` - Plugin entry point and hook registration.

**Ignore**
- `dist/`, `node_modules/`, `**/*.test.ts`.
</context_hints>
